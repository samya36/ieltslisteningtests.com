<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- ÂÆâÂÖ®HTTPÂ§¥ -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' https://cdnjs.cloudflare.com;
        style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com;
        font-src 'self' https://cdnjs.cloudflare.com data:;
        img-src 'self' data: blob:;
        audio-src 'self' https://cdn.jsdelivr.net data: blob:;
        connect-src 'self' https://cdn.jsdelivr.net;
        object-src 'none';
        base-uri 'self';
        form-action 'self';
        frame-ancestors 'none';
        upgrade-insecure-requests;
    ">
    
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    
    <title>Enhanced IELTS Listening Test 1</title>
    
    <!-- Ê†∑ÂºèÊñá‰ª∂ -->
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/test.css">
    <link rel="stylesheet" href="../css/accessibility.css">
    <link rel="stylesheet" href="../css/mobile-optimizations.css">
    <link rel="stylesheet" href="../css/enhanced-components.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Ë∑≥ËøáÂØºËà™ÈìæÊé• -->
    <a href="#main-content" class="skip-link">Ë∑≥ËøáÂØºËà™ÔºåÁõ¥Êé•Âà∞‰∏ªË¶ÅÂÜÖÂÆπ</a>
    
    <!-- Â±èÂπïÈòÖËØªÂô®ÈÄöÂëäÂå∫Âüü -->
    <div id="sr-announcements" aria-live="polite" aria-atomic="true" style="position: absolute; left: -10000px; width: 1px; height: 1px; overflow: hidden;"></div>
    
    <!-- ÂØºËà™Ê†è -->
    <nav class="nav-bar">
        <div class="nav-container">
            <div class="logo">
                <a href="../index.html" class="home-link">
                    <img src="../images/logo.png" alt="IELTSÂê¨ÂäõËØÑÂàÜËß£Êûê" class="logo-img">
                    IELTSÂê¨ÂäõËØÑÂàÜËß£Êûê
                </a>
            </div>
            <button class="nav-toggle" aria-label="ÂàáÊç¢ÂØºËà™ËèúÂçï" aria-expanded="false">
                <i class="fas fa-bars"></i>
            </button>
            <ul class="nav-menu">
                <li><a href="../index.html">È¶ñÈ°µ</a></li>
                <li><a href="scoring.html">ËØÑÂàÜËØ¶Ëß£</a></li>
                <li><a href="cases.html">Ê°à‰æãÂàÜÊûê</a></li>
                <li><a href="practice.html">Âê¨ÂäõÁªÉ‰π†</a></li>
                <li><button onclick="keyboardNavigation?.showHelp()" class="help-btn">
                    <i class="fas fa-keyboard"></i> Âø´Êç∑ÈîÆ
                </button></li>
            </ul>
        </div>
    </nav>

    <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫ -->
    <main class="test-container" id="main-content">
        <!-- ÊµãËØïËØ¥Êòé -->
        <div class="test-intro">
            <div class="test-header">
                <h1>üéÜ Enhanced IELTS Listening Test 1</h1>
                <div class="test-badges">
                    <span class="badge difficulty">‰∏≠Á≠âÈöæÂ∫¶</span>
                    <span class="badge duration">30ÂàÜÈíü</span>
                    <span class="badge questions">40È¢ò</span>
                </div>
            </div>
            
            <div class="enhancement-notice">
                <div class="notice-icon">üöÄ</div>
                <div class="notice-content">
                    <h3>Â¢ûÂº∫ÁâπÊÄß</h3>
                    <ul class="feature-list">
                        <li><i class="fas fa-keyboard"></i> ÂÖ®Èù¢ÈîÆÁõòÂø´Êç∑ÈîÆÊîØÊåÅ</li>
                        <li><i class="fas fa-play-circle"></i> Èü≥È¢ëÊñ≠ÁÇπË∑≥ËΩ¨ÂäüËÉΩ</li>
                        <li><i class="fas fa-star"></i> Êô∫ËÉΩÈ¢òÁõÆÊ†áËÆ∞Á≥ªÁªü</li>
                        <li><i class="fas fa-mobile-alt"></i> ÁßªÂä®Á´Ø‰ºòÂåñ‰ΩìÈ™å</li>
                        <li><i class="fas fa-save"></i> Ëá™Âä®ËøõÂ∫¶‰øùÂ≠ò</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="test-layout">
            <!-- Â∑¶‰æß‰∏ªË¶ÅÂÜÖÂÆπ -->
            <div class="test-main">
                <!-- Â¢ûÂº∫Èü≥È¢ëÊí≠ÊîæÂô® -->
                <div class="enhanced-audio-player">
                    <div class="audio-section" id="audio-section-1">
                        <div class="audio-player-main">
                            <audio id="section1-player" 
                                   src="../audio/test1/Part1%20Amateur%20Dramatic%20Society.m4a"
                                   data-local-src="../audio/test1/Part1%20Amateur%20Dramatic%20Society.m4a"
                                   preload="none"></audio>
                        </div>
                        <div class="audio-controls">
                            <button id="section1-play" class="play-btn" aria-label="Êí≠Êîæ/ÊöÇÂÅúSection 1">
                                <i class="fas fa-play"></i>
                            </button>
                            <div class="speed-control">
                                <button class="speed-btn" onclick="enhancedAudioPlayer?.speedDown()">‚àí</button>
                                <span class="speed-display">1.00x</span>
                                <button class="speed-btn" onclick="enhancedAudioPlayer?.speedUp()">+</button>
                            </div>
                        </div>
                        <div class="breakpoint-controls" id="breakpoint-controls">
                            <!-- Êñ≠ÁÇπÊåâÈíÆÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
                        </div>
                    </div>
                    
                    <div class="audio-progress">
                        <input type="range" id="section1-progress" class="progress" min="0" max="100" value="0">
                        <div class="time-display">
                            <span id="section1-time">00:00 / 00:00</span>
                        </div>
                    </div>
                </div>

                <!-- ÈÉ®ÂàÜÂàáÊç¢Ê†áÁ≠æÈ°µ -->
                <div class="section-tabs" role="tablist">
                    <button class="section-tab active" data-section="1" role="tab" 
                            aria-selected="true" id="section1-tab">Section 1</button>
                    <button class="section-tab" data-section="2" role="tab" 
                            aria-selected="false" id="section2-tab">Section 2</button>
                    <button class="section-tab" data-section="3" role="tab" 
                            aria-selected="false" id="section3-tab">Section 3</button>
                    <button class="section-tab" data-section="4" role="tab" 
                            aria-selected="false" id="section4-tab">Section 4</button>
                </div>

                <!-- È¢òÁõÆÂÜÖÂÆπÂå∫Âüü -->
                <div class="questions-container">
                    <div class="question-container active" id="section1-content" role="tabpanel">
                        <div class="section-header">
                            <h2>Section 1</h2>
                            <p class="section-instructions">
                                <strong>Questions 1-10</strong><br>
                                Complete the form below.<br>
                                Write <strong>ONE WORD OR A NUMBER</strong> for each answer.
                            </p>
                        </div>
                        
                        <!-- Á§∫‰æãÈ¢òÁõÆ - Â°´Á©∫È¢ò -->
                        <div class="form-content">
                            <h3>Amateur Dramatic Society</h3>
                            <p><strong>Secretary:</strong> Jane Caulfield</p>
                            <p><strong>Mailing address:</strong> 117 Green Road, Prestwin</p>
                            
                            <div class="question-item" data-question="1">
                                <label for="q1">Location for rehearsals: The 
                                    <input type="text" id="q1" class="fill-blank" placeholder="1" maxlength="20">
                                     House, Wynn
                                </label>
                            </div>
                            
                            <div class="question-item" data-question="2">
                                <p>No experience necessary</p>
                                <label for="q2">They need actors and 
                                    <input type="text" id="q2" class="fill-blank" placeholder="2" maxlength="20">
                                     singers
                                </label>
                            </div>
                            
                            <div class="question-item" data-question="3">
                                <label for="q3">Also need people who can 
                                    <input type="text" id="q3" class="fill-blank" placeholder="3" maxlength="20">
                                </label>
                            </div>
                            
                            <div class="question-item" data-question="4">
                                <label for="q4">Meetings 6‚Äì8 p.m. every 
                                    <input type="text" id="q4" class="fill-blank" placeholder="4" maxlength="20">
                                </label>
                            </div>
                            
                            <div class="question-item" data-question="5">
                                <label for="q5">Closed in 
                                    <input type="text" id="q5" class="fill-blank" placeholder="5" maxlength="20">
                                     (for 2 weeks)
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÂÖ∂‰ªñsectionÂÜÖÂÆπÁ±ª‰ºº... -->
                    <div class="question-container" id="section2-content" role="tabpanel" style="display: none;">
                        <div class="section-header">
                            <h2>Section 2</h2>
                            <p class="section-instructions">
                                <strong>Questions 11-14</strong><br>
                                Choose the correct letter, <strong>A, B or C</strong>.
                            </p>
                        </div>
                        
                        <!-- Á§∫‰æãÈÄâÊã©È¢ò -->
                        <div class="mcq-container">
                            <div class="question-item" data-question="11">
                                <h4>11. What should employees bring to work?</h4>
                                <div class="options">
                                    <label class="option-label">
                                        <input type="radio" name="q11" value="A">
                                        <span class="option-text">A. gloves</span>
                                    </label>
                                    <label class="option-label">
                                        <input type="radio" name="q11" value="B">
                                        <span class="option-text">B. lunch</span>
                                    </label>
                                    <label class="option-label">
                                        <input type="radio" name="q11" value="C">
                                        <span class="option-text">C. water</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Êèê‰∫§ÊåâÈíÆ -->
                <div class="test-actions">
                    <button class="btn-secondary" id="btn-reset">
                        <i class="fas fa-redo"></i> ÈáçÊñ∞ÂºÄÂßã
                    </button>
                    <button class="btn-primary" id="btn-submit">
                        <i class="fas fa-paper-plane"></i> Êèê‰∫§Á≠îÊ°à
                    </button>
                </div>
            </div>

            <!-- Âè≥‰æßÂ¢ûÂº∫Á≠îÈ¢òÂç° -->
            <aside class="test-sidebar">
                <div class="answer-sheet-container" id="answer-sheet-container">
                    <!-- Á≠îÈ¢òÂç°ÂÜÖÂÆπÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
                </div>
                
                <!-- ËøõÂ∫¶ÊòæÁ§∫ -->
                <div class="progress-panel">
                    <h4>Á≠îÈ¢òËøõÂ∫¶</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%"></div>
                    </div>
                    <div class="progress-text">0 / 40 È¢òÂ∑≤ÂÆåÊàê</div>
                </div>
            </aside>
        </div>
    </main>

    <!-- ÂèçÈ¶àÂÆπÂô® -->
    <div id="feedback-container"></div>

    <!-- JavaScriptÊñá‰ª∂ -->
    <script src="../js/enhanced-audio-player.js" defer></script>
    <script src="../js/enhanced-answer-sheet.js" defer></script>
    <script src="../js/enhanced-keyboard-navigation.js" defer></script>
    <script src="../js/test-data.js" defer></script>
    <script src="../js/test-answers.js" defer></script>
    <script src="../js/enhanced-test1-init.js" defer></script>
    
    <!-- ‰∏ªÂàùÂßãÂåñËÑöÊú¨ -->
    <!-- removed: inline script moved to external file -->
    document.addEventListener('DOMContentLoaded', function() {
        // ÂàùÂßãÂåñÈ¢òÁõÆÊï∞ÊçÆ
        if (typeof TEST_DATA !== 'undefined' && enhancedAnswerSheet) {
            const allQuestions = [];
            
            // ‰ªé TEST_DATA ÊèêÂèñÊâÄÊúâÈ¢òÁõÆ
            Object.keys(TEST_DATA).forEach(sectionKey => {
                const section = TEST_DATA[sectionKey];
                if (section.questions) {
                    section.questions.forEach(q => allQuestions.push(q));
                } else if (section.parts) {
                    section.parts.forEach(part => {
                        if (part.questions) {
                            part.questions.forEach(q => allQuestions.push(q));
                        }
                    });
                }
            });
            
            enhancedAnswerSheet.setQuestions(allQuestions);
        }
        
        // ÁõëÂê¨Á≠îÈ¢òÂèòÂåñ
        document.addEventListener('input', function(e) {
            if (e.target.matches('input[type="text"], input[type="radio"]')) {
                const questionId = e.target.id || e.target.name;
                const value = e.target.type === 'radio' ? 
                    (e.target.checked ? e.target.value : null) : e.target.value;
                
                if (enhancedAnswerSheet && questionId) {
                    enhancedAnswerSheet.updateAnswer(questionId, value);
                }
                
                updateProgress();
            }
        });
        
        // Êõ¥Êñ∞ËøõÂ∫¶
        function updateProgress() {
            const inputs = document.querySelectorAll('input[type="text"], input[type="radio"]:checked');
            const totalQuestions = document.querySelectorAll('.question-item').length;
            const answeredCount = Array.from(inputs).filter(input => {
                return input.type === 'radio' ? input.checked : input.value.trim() !== '';
            }).length;
            
            const percentage = (answeredCount / totalQuestions) * 100;
            
            const progressFill = document.querySelector('.progress-fill');
            const progressText = document.querySelector('.progress-text');
            
            if (progressFill) progressFill.style.width = percentage + '%';
            if (progressText) progressText.textContent = `${answeredCount} / ${totalQuestions} È¢òÂ∑≤ÂÆåÊàê`;
        }
        
        // ÁõëÂê¨Á≠îÈ¢òÂç°‰∫ã‰ª∂
        document.addEventListener('answerSheet:questionChanged', function(e) {
            const questionIndex = e.detail.index;
            // ÂàáÊç¢Âà∞ÂØπÂ∫îÈ¢òÁõÆ
            console.log('ÂàáÊç¢Âà∞È¢òÁõÆ', questionIndex + 1);
        });
        
        // SectionÂàáÊç¢‰∫ã‰ª∂
        document.querySelectorAll('.section-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const sectionNum = this.dataset.section;
                switchToSection(sectionNum);
            });
        });
        
        function switchToSection(sectionNum) {
            // Êõ¥Êñ∞Ê†áÁ≠æÊ†∑Âºè
            document.querySelectorAll('.section-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.setAttribute('aria-selected', 'false');
            });
            
            const activeTab = document.querySelector(`[data-section="${sectionNum}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
                activeTab.setAttribute('aria-selected', 'true');
            }
            
            // Êõ¥Êñ∞ÂÜÖÂÆπÂå∫Âüü
            document.querySelectorAll('.question-container').forEach(container => {
                container.style.display = 'none';
            });
            
            const activeContent = document.getElementById(`section${sectionNum}-content`);
            if (activeContent) {
                activeContent.style.display = 'block';
            }
            
            // ÈÄöÁü•Èü≥È¢ëÊí≠ÊîæÂô®
            if (enhancedAudioPlayer) {
                enhancedAudioPlayer.currentSection = parseInt(sectionNum);
            }
        }
        
        // ÂàùÂßãÂåñÈîÆÁõòÂØºËà™Á≥ªÁªü
        if (keyboardNavigation) {
            keyboardNavigation.updateQuestionInfo(0, 40);
        }
        
        // ÊòæÁ§∫ÂêØÂä®ÊèêÁ§∫
        setTimeout(() => {
            if (enhancedAnswerSheet) {
                enhancedAnswerSheet.showFeedback('üéÜ Â¢ûÂº∫ÊµãËØïÁ≥ªÁªüÂ∑≤ÂêØÂä®ÔºÅÊåâ H Êü•ÁúãÂ∏ÆÂä©', 'info');
            }
        }, 1500);
    });
    
    // ÂÖ®Â±ÄÂáΩÊï∞
    function resetTest() {
        if (confirm('Á°ÆÂÆöË¶ÅÈáçÊñ∞ÂºÄÂßãÊµãËØïÂêóÔºüÊâÄÊúâÁ≠îÊ°àÂ∞ÜË¢´Ê∏ÖÈô§„ÄÇ')) {
            // Ê∏ÖÈô§ÊâÄÊúâËæìÂÖ•
            document.querySelectorAll('input').forEach(input => {
                if (input.type === 'radio' || input.type === 'checkbox') {
                    input.checked = false;
                } else {
                    input.value = '';
                }
            });
            
            // ÈáçÁΩÆÁ≠îÈ¢òÂç°
            if (enhancedAnswerSheet) {
                enhancedAnswerSheet.reset();
            }
            
            // ÈáçÁΩÆÈü≥È¢ëÊí≠ÊîæÂô®
            if (enhancedAudioPlayer) {
                Object.values(enhancedAudioPlayer.players).forEach(player => {
                    if (player && player.audio) {
                        player.audio.pause();
                        player.audio.currentTime = 0;
                    }
                });
            }
            
            // Êõ¥Êñ∞ËøõÂ∫¶
            updateProgress();
        }
    }
    
    function submitTest() {
        // Êî∂ÈõÜÊâÄÊúâÁ≠îÊ°à
        const rawInputs = {};
        document.querySelectorAll('input').forEach(input => {
            if (input.type === 'radio' && input.checked) {
                rawInputs[input.name] = input.value;
            } else if (input.type === 'text' && input.value.trim()) {
                rawInputs[input.id] = input.value.trim();
            }
        });

        // ÂΩí‰∏ÄÂåñ‰∏∫ sectionX_Y ÈîÆ
        const userAnswers = {};
        const toKey = (qNum) => {
            const n = parseInt(String(qNum), 10);
            const section = Math.min(4, Math.max(1, Math.ceil(n / 10)));
            return `section${section}_${n}`;
        };
        Object.entries(rawInputs).forEach(([k, v]) => {
            const match = String(k).match(/(\d{1,2})/);
            if (match) userAnswers[toKey(match[1])] = v;
        });

        // ÊûÑÂª∫Á≠îÊ°àÈîÆÊò†Â∞Ñ
        const answerKey = {};
        if (typeof standardAnswers !== 'undefined') {
            Object.entries(standardAnswers).forEach(([num, ans]) => {
                answerKey[toKey(num)] = ans;
            });
        }

        try { localStorage.setItem('userAnswers', JSON.stringify(userAnswers)); } catch (_) {}
        if (window.ScoreEngine && typeof window.ScoreEngine.calculate === 'function') {
            const scoreResult = window.ScoreEngine.calculate(userAnswers, answerKey);
            try {
                localStorage.setItem('latestScoreResult', JSON.stringify(scoreResult));
                localStorage.setItem('latestAnswerKey', JSON.stringify(answerKey));
            } catch (_) {}
            console.log('[ScoreEngine] ËØÑÂàÜÁªìÊûú', scoreResult);
        }

        if (enhancedAnswerSheet) {
            enhancedAnswerSheet.showFeedback('Á≠îÊ°àÂ∑≤Êèê‰∫§ÔºÅÂç≥Â∞ÜÊòæÁ§∫ËØÑÂàÜ', 'success');
        }
        setTimeout(() => { window.location.href = 'score-validator.html'; }, 800);
    }
    
    <script src="../js/score-engine.js" defer></script>
    <script src="../js/test-page-events.js" defer></script>
</body>
</html>

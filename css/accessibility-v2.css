/* ==============================================
   可访问性增强 v2.0
   遵循 WCAG 2.1 AA 标准的无障碍设计
   ============================================== */

/* === 颜色对比度增强 === */
:root {
  /* 确保足够的颜色对比度（至少 4.5:1） */
  --text-contrast-primary: #1a1a1a;
  --text-contrast-secondary: #4a4a4a;
  --background-contrast: #ffffff;
  --link-contrast: #0066cc;
  --link-visited-contrast: #663399;
  --focus-contrast: #005fcc;
  --error-contrast: #cc0000;
  --success-contrast: #006600;
  --warning-contrast: #cc6600;
}

/* 高对比度模式支持 */
@media (prefers-contrast: high) {
  :root {
    --text-primary: var(--text-contrast-primary);
    --text-secondary: var(--text-contrast-secondary);
    --surface-primary: var(--background-contrast);
    --primary-500: var(--link-contrast);
    --error-color: var(--error-contrast);
    --success-color: var(--success-contrast);
    --warning-color: var(--warning-contrast);
    
    /* 增强边框对比度 */
    --border-light: #333333;
    --border-medium: #666666;
    --border-dark: #000000;
  }
  
  /* 增强所有边框 */
  .btn,
  .input,
  .card,
  .question-item-v2,
  .option-item-v2 {
    border-width: 2px !important;
  }
  
  /* 增强焦点指示器 */
  .btn:focus,
  .input:focus,
  .nav-button:focus,
  .option-item-v2:focus-within {
    outline: 3px solid var(--focus-contrast) !important;
    outline-offset: 2px !important;
  }
}

/* === 焦点管理和键盘导航 === */

/* 跳过链接 - 改进样式 */
.skip-link {
  position: absolute;
  top: -40px;
  left: 6px;
  background: var(--primary-700);
  color: var(--neutral-0);
  padding: 8px 16px;
  text-decoration: none;
  border-radius: var(--radius-lg);
  font-weight: var(--font-weight-semibold);
  font-size: var(--font-size-sm);
  z-index: var(--z-skiplink);
  transition: all var(--transition-fast);
}

.skip-link:focus {
  top: 6px;
  outline: 2px solid var(--accent-400);
  outline-offset: 2px;
}

/* 增强的焦点指示器 */
.focus-visible,
*:focus-visible {
  outline: 2px solid var(--primary-500);
  outline-offset: 2px;
  border-radius: var(--radius-sm);
}

/* 交互元素的焦点样式 */
.btn:focus,
.input:focus,
.nav-button:focus {
  outline: 2px solid var(--primary-500);
  outline-offset: 2px;
  box-shadow: 0 0 0 4px rgb(33 150 243 / 0.1);
}

.nav-menu-v2 a:focus {
  outline: 2px solid var(--primary-500);
  outline-offset: 2px;
  background: var(--primary-50);
  color: var(--primary-700);
}

/* 自定义单选按钮的焦点样式 */
.option-item-v2:focus-within {
  outline: 2px solid var(--primary-500);
  outline-offset: 2px;
  border-color: var(--primary-500);
}

/* 标签页焦点样式 */
.section-tab-v2:focus {
  outline: 2px solid var(--primary-500);
  outline-offset: 2px;
  background: var(--primary-100);
}

/* === 屏幕阅读器支持 === */

/* 屏幕阅读器专用文本 */
.sr-only {
  position: absolute !important;
  width: 1px !important;
  height: 1px !important;
  padding: 0 !important;
  margin: -1px !important;
  overflow: hidden !important;
  clip: rect(0, 0, 0, 0) !important;
  white-space: nowrap !important;
  border: 0 !important;
}

/* 可选择性隐藏（保留交互） */
.visually-hidden-interactive {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

.visually-hidden-interactive:focus {
  position: static;
  width: auto;
  height: auto;
  padding: var(--space-2) var(--space-4);
  margin: 0;
  overflow: visible;
  clip: auto;
  white-space: normal;
}

/* === ARIA 状态和属性的视觉支持 === */

/* 展开/折叠状态 */
[aria-expanded="true"] .expand-icon {
  transform: rotate(180deg);
}

[aria-expanded="false"] .expand-icon {
  transform: rotate(0deg);
}

/* 选中状态 */
[aria-selected="true"] {
  background: var(--primary-50);
  color: var(--primary-700);
  border-color: var(--primary-500);
}

/* 禁用状态 */
[aria-disabled="true"],
[disabled] {
  opacity: 0.6;
  cursor: not-allowed;
  pointer-events: none;
}

/* 必填字段 */
[aria-required="true"],
[required] {
  position: relative;
}

[aria-required="true"]::after,
[required]::after {
  content: '*';
  color: var(--error-color);
  font-weight: var(--font-weight-bold);
  margin-left: var(--space-1);
}

/* 错误状态 */
[aria-invalid="true"] {
  border-color: var(--error-color);
  background: rgb(244 67 54 / 0.05);
}

[aria-invalid="true"]:focus {
  outline-color: var(--error-color);
  box-shadow: 0 0 0 4px rgb(244 67 54 / 0.1);
}

/* === 动画和运动偏好 === */

/* 减少动画偏好 */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
    scroll-behavior: auto !important;
  }
  
  /* 禁用特定的动画效果 */
  .hero-cta-primary:hover,
  .hero-cta-secondary:hover,
  .btn:hover,
  .nav-button:hover,
  .card:hover,
  .feature-card-v2:hover,
  .test-card-v2:hover {
    transform: none !important;
  }
  
  /* 保留必要的状态变化 */
  .nav-menu-v2.active {
    transition: opacity 0.1s ease !important;
  }
}

/* === 字体大小缩放支持 === */

/* 支持用户自定义字体大小 */
@media (min-resolution: 120dpi) {
  html {
    font-size: 18px;
  }
}

/* 大字体模式 */
@media (prefers-reduced-motion: no-preference) and (min-width: 1200px) {
  html {
    font-size: 18px;
  }
}

/* === 触摸设备优化 === */

/* 增大触摸目标 */
@media (pointer: coarse) {
  .btn,
  .nav-button,
  .option-item-v2,
  .speed-button,
  .play-button-v2,
  .section-tab-v2 {
    min-height: 44px;
    min-width: 44px;
    padding: max(var(--space-3), 12px);
  }
  
  /* 增加触摸间距 */
  .nav-menu-v2 {
    gap: var(--space-4);
  }
  
  .multiple-choice-options {
    gap: var(--space-4);
  }
  
  .speed-controls {
    gap: var(--space-3);
  }
}

/* === 语音用户界面支持 === */

/* 为语音输入提供更好的标识 */
.voice-input-active {
  background: var(--accent-50);
  border-color: var(--accent-500);
  animation: voice-pulse 1.5s infinite;
}

@keyframes voice-pulse {
  0%, 100% {
    box-shadow: 0 0 0 0 rgb(255 152 0 / 0.4);
  }
  50% {
    box-shadow: 0 0 0 8px rgb(255 152 0 / 0.1);
  }
}

/* === 错误处理和反馈 === */

/* 错误消息样式 */
.error-message {
  color: var(--error-color);
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  margin-top: var(--space-2);
  display: flex;
  align-items: center;
  gap: var(--space-2);
}

.error-message::before {
  content: '⚠️';
  font-size: var(--font-size-base);
}

/* 成功消息样式 */
.success-message {
  color: var(--success-color);
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  margin-top: var(--space-2);
  display: flex;
  align-items: center;
  gap: var(--space-2);
}

.success-message::before {
  content: '✅';
  font-size: var(--font-size-base);
}

/* === 实时反馈和状态指示 === */

/* 加载状态 */
.loading {
  position: relative;
  pointer-events: none;
}

.loading::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 20px;
  height: 20px;
  margin: -10px 0 0 -10px;
  border: 2px solid var(--primary-200);
  border-top: 2px solid var(--primary-500);
  border-radius: var(--radius-full);
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* 进度指示 */
.progress-indicator {
  display: flex;
  align-items: center;
  gap: var(--space-2);
  font-size: var(--font-size-sm);
  color: var(--text-secondary);
}

.progress-indicator[aria-valuenow] {
  position: relative;
}

.progress-indicator[aria-valuenow]::after {
  content: attr(aria-valuenow) '/' attr(aria-valuemax);
  font-family: var(--font-family-mono);
  font-weight: var(--font-weight-medium);
}

/* === 通知和提醒 === */

/* Live region for announcements */
.live-region {
  position: absolute;
  left: -10000px;
  width: 1px;
  height: 1px;
  overflow: hidden;
}

/* Toast notifications */
.toast {
  position: fixed;
  bottom: var(--space-6);
  right: var(--space-6);
  background: var(--surface-elevated);
  border: 1px solid var(--border-medium);
  border-radius: var(--radius-xl);
  padding: var(--space-4) var(--space-6);
  box-shadow: var(--shadow-lg);
  z-index: var(--z-toast);
  max-width: 400px;
  
  animation: toast-slide-in 0.3s ease-out;
}

.toast.success {
  border-color: var(--success-color);
  background: var(--surface-primary);
}

.toast.error {
  border-color: var(--error-color);
  background: var(--surface-primary);
}

.toast.warning {
  border-color: var(--warning-color);
  background: var(--surface-primary);
}

@keyframes toast-slide-in {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* === 帮助和指导 === */

/* 工具提示 */
.tooltip {
  position: relative;
  display: inline-block;
  cursor: help;
}

.tooltip[aria-describedby] {
  text-decoration: underline;
  text-decoration-style: dotted;
}

.tooltip-content {
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: var(--neutral-800);
  color: var(--neutral-0);
  padding: var(--space-2) var(--space-3);
  border-radius: var(--radius-lg);
  font-size: var(--font-size-xs);
  white-space: nowrap;
  z-index: var(--z-tooltip);
  opacity: 0;
  visibility: hidden;
  transition: all var(--transition-fast);
}

.tooltip:hover .tooltip-content,
.tooltip:focus .tooltip-content {
  opacity: 1;
  visibility: visible;
}

/* === 数据表格可访问性 === */

/* 改进的表格标题 */
.table th {
  position: relative;
  cursor: pointer;
}

.table th[aria-sort] {
  background: var(--primary-50);
}

.table th[aria-sort="ascending"]::after {
  content: '↑';
  position: absolute;
  right: var(--space-2);
}

.table th[aria-sort="descending"]::after {
  content: '↓';
  position: absolute;
  right: var(--space-2);
}

/* 表格行选择 */
.table tr[aria-selected="true"] {
  background: var(--primary-50);
  border-color: var(--primary-300);
}

/* === 打印样式优化 === */

@media print {
  /* 隐藏交互元素 */
  .nav-bar-v2,
  .nav-toggle,
  .btn,
  .nav-button,
  .audio-panel-v2 {
    display: none !important;
  }
  
  /* 优化文本对比度 */
  * {
    color: #000000 !important;
    background: #ffffff !important;
  }
  
  /* 保留重要边框 */
  .card,
  .question-item-v2 {
    border: 1px solid #000000 !important;
  }
  
  /* 优化链接显示 */
  a::after {
    content: ' (' attr(href) ')';
    font-size: var(--font-size-xs);
    color: #666666;
  }
}

/* === 性能优化 === */

/* 减少重绘和重排 */
.will-change-transform {
  will-change: transform;
}

.will-change-opacity {
  will-change: opacity;
}

/* GPU 加速动画 */
.gpu-accelerated {
  transform: translateZ(0);
  backface-visibility: hidden;
  perspective: 1000px;
}

/* === 多语言支持 === */

/* 右到左语言支持 */
[dir="rtl"] {
  text-align: right;
}

[dir="rtl"] .nav-menu-v2 {
  flex-direction: row-reverse;
}

[dir="rtl"] .hero-actions {
  flex-direction: row-reverse;
}

/* === 用户偏好尊重 === */

/* 透明度偏好 */
@media (prefers-reduced-transparency: reduce) {
  .nav-bar-v2 {
    backdrop-filter: none;
    background: var(--surface-primary);
  }
  
  .modal-overlay {
    background: rgba(0, 0, 0, 0.8);
  }
}